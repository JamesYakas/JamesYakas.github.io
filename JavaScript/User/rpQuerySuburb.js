Backendless.serverURL="https://api.backendless.com",Backendless.initApp("073669A8-CCB7-2AED-FFEC-841A4CE5F400","FAFDE171-5308-49CF-9980-AA89E4F28F0C");var suburb=localStorage.getItem("usersSuburb"),initialSearch=!0,_typeOfSpecial=["Drink"],masterEstablishments=[],masterMarkers=[],filteredMarkers=[],useFilteredMarkers=!1,lat=0,lng=0;function pageOnLoad(){if(!initialSearch){useFilteredMarkers=!1,document.getElementById("tabDrink").classList.add("active"),$("#daysOfWeekFilter").val(""),document.getElementById("timePeriodStartFilter").selectedIndex="0",document.getElementById("timePeriodEndFilter").selectedIndex="16",$("#specialCategoryFilter").val("");for(i=0,l={},a=["Breakfast Special","Lunch Special","Dinner Special","Happy Hour"],n=0;n<a.length;n++)l[a[n]]=n;var e=Backendless.DataQueryBuilder.create();return e.setRelated(["establishmentSpecials"]),e.setWhereClause("Suburb = '"+suburb+"'"),Backendless.Data.of("Establishment").find(e).then(function(e){document.getElementById("rpList").innerHTML="";for(var t=["Drink"],s=e.reduce((e,s)=>{const l=s.establishmentSpecials.filter(e=>t.includes(e.Type_Of_Special));return l.length>0?[...e,{...s,establishmentSpecials:l}]:e},[]),a=0;a<s.length;a++)if(console.log(s),s[a].establishmentSpecials.length>0){s[a].establishmentSpecials.sort(function(e,t){return l[e.Category]-l[t.Category]||e.Start_Time.localeCompare(t.Start_Time)}),document.getElementById("rpList").innerHTML+='<div class="establishment-wrapper"><a href="establishment.html"><img class="rpImage" src="'+s[a].Image+'"></a><br><b>'+s[a].Name+"</b><br>"+s[a].Cuisine_Type+"<br>"+s[a].Address+"<br><br></div>",document.getElementById("rpList").innerHTML+='<div class="tbl-wrapper" ><table id=\'tbl\'  class="striped"><colgroup><col span="1" class="tbl-special"><col span="1" class="tbl-days"></colgroup><thead><tr><th class="tbl-special-th">Special</th><th class="tbl-days-th">Days</th></tr></thead><tbody id="myTable'+a+'"></tbody></table></div>';for(var n=0;n<s[a].establishmentSpecials.length;n++){var r,o=document.getElementById("myTable"+a);r=s[a].establishmentSpecials[n].Days_Of_Week.split(", "),console.log(r);for(var c="M ",d="T ",p="W ",m="T ",u="F ",b="S ",g="S",h=0;h<r.length;h++)"Monday"==r[h]?c=c.fontcolor("#FF3399"):"Tuesday"==r[h]?d=d.fontcolor("#FF3399"):"Wednesday"==r[h]?p=p.fontcolor("#FF3399"):"Thursday"==r[h]?m=m.fontcolor("#FF3399"):"Friday"==r[h]?u=u.fontcolor("#FF3399"):"Saturday"==r[h]?b=b.fontcolor("#FF3399"):"Sunday"==r[h]&&(g=g.fontcolor("#FF3399"));addRow(o,'<div class="category">'+s[a].establishmentSpecials[n].Category.replace("Special","")+"</div>",'<div class="time-period">'+tConvert(s[a].establishmentSpecials[n].Start_Time)+" - "+tConvert(s[a].establishmentSpecials[n].End_Time)+"</div>",s[a].establishmentSpecials[n].objectId),addRowBottom(o,s[a].establishmentSpecials[n].Description,'<div class="daysAbbreviated">'+c+d+p+m+u+b+g+"</div>",s[a].establishmentSpecials[n].objectId),i++}document.getElementById("rpList").innerHTML+="<br>"}var y=document.getElementById("cusineTypeFilter");$("#cusineTypeFilter").empty();var f=0,S=e.length,F=[];for(f=0;f<S;f++)F.push(e[f].Cuisine_Type),0;var v=F.filter(onlyUnique),k=1,E=0,I=v.length;for(E=0;E<I;E++)y.options[0]=new Option("Any",""),y.options[0].disabled=!0,y.options[k]=new Option(v[E],v[E]),k++;$("select").formSelect();var T=document.querySelectorAll("#foodDrink");M.Tabs.init(T,{duration:100}),document.getElementById("tabDrink").classList.add("active"),_typeOfSpecial=["Drink"],masterEstablishments=e,document.getElementById("rpNumOfSpecialsFound").innerHTML="Found '"+i+"' matching Drink specials",document.getElementById("rpDisplaySuburb").innerHTML=suburb.fontsize(6)+" Specials ".fontsize(6)+"- 2029",document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",console.log("1. Populate list")}).then(()=>{var e=suburb;return axios.get("https://maps.googleapis.com/maps/api/geocode/json?components=country:NZ|country:AU",{params:{address:e,key:"AIzaSyBmpzz0lX4w2UV3KXivbLrQ3AHJUvOzbOI"}}).then(function(e){lat=e.data.results[0].geometry.location.lat,lng=e.data.results[0].geometry.location.lng,console.log("2. Get suburb coords")}).then(()=>{console.log("3. Start map markers creation");for(var e=0;e<masterEstablishments.length;e++)if(masterEstablishments[e].establishmentSpecials.length>0){console.log("4.1 Start creating a single marker");console.log(masterEstablishments[e].Location.y),masterMarkers.push({coords:{lat:masterEstablishments[e].Location.y,lng:masterEstablishments[e].Location.x},iconImage:"images/restaurant.png",content:'<a href="establishment.html">'+masterEstablishments[e].Name+"</a><br>"+masterEstablishments[e].Cuisine_Type+"<br>"+masterEstablishments[e].Address+"<br>",Cuisine_Type:masterEstablishments[e].Cuisine_Type,establishmentSpecials:masterEstablishments[e].establishmentSpecials}),console.log("4.2 Finish creating a single marker")}console.log("5. Finish map markers creation")}).then(()=>{console.log("6. Initialize map"),initMap()})}).catch(function(e){})}var t=sessionStorage.getItem("suburbResults"),s=JSON.parse(t);document.getElementById("rpList").innerHTML="";for(var l={},a=["Breakfast Special","Lunch Special","Dinner Special","Happy Hour"],n=0;n<a.length;n++)l[a[n]]=n;for(var i=0,r=["Drink"],o=s.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>r.includes(e.Type_Of_Special));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[]),n=0;n<o.length;n++)if(o[n].establishmentSpecials.length>0){o[n].establishmentSpecials.sort(function(e,t){return l[e.Category]-l[t.Category]||e.Start_Time.localeCompare(t.Start_Time)}),document.getElementById("rpList").innerHTML+='<div class="establishment-wrapper"><a href="establishment.html"><img class="rpImage" src="'+o[n].Image+'"></a><br><b>'+o[n].Name+"</b><br>"+o[n].Cuisine_Type+"<br>"+o[n].Address+"<br><br></div>",document.getElementById("rpList").innerHTML+='<div class="tbl-wrapper" ><table id=\'tbl\' class="striped"><colgroup><col span="1" class="tbl-special"><col span="1" class="tbl-days"></colgroup><thead><tr><th class="tbl-special-th">Special</th><th class="tbl-days-th">Days</th></tr></thead><tbody id="myTable'+n+'"></tbody></table></div>';for(var c=0;c<o[n].establishmentSpecials.length;c++){var d,p=document.getElementById("myTable"+n);d=o[n].establishmentSpecials[c].Days_Of_Week.split(", ");for(var m="M ",u="T ",b="W ",g="T ",h="F ",y="S ",f="S",S=0;S<d.length;S++)"Monday"==d[S]?m=m.fontcolor("#FF3399"):"Tuesday"==d[S]?u=u.fontcolor("#FF3399"):"Wednesday"==d[S]?b=b.fontcolor("#FF3399"):"Thursday"==d[S]?g=g.fontcolor("#FF3399"):"Friday"==d[S]?h=h.fontcolor("#FF3399"):"Saturday"==d[S]?y=y.fontcolor("#FF3399"):"Sunday"==d[S]&&(f=f.fontcolor("#FF3399"));addRow(p,'<div class="category">'+o[n].establishmentSpecials[c].Category.replace("Special","")+"</div>",'<div class="time-period">'+tConvert(o[n].establishmentSpecials[c].Start_Time)+" - "+tConvert(o[n].establishmentSpecials[c].End_Time)+"</div>",o[n].establishmentSpecials[c].objectId),addRowBottom(p,o[n].establishmentSpecials[c].Description,'<div class="daysAbbreviated">'+m+u+b+g+h+y+f+"</div>",o[n].establishmentSpecials[c].objectId),i++}document.getElementById("rpList").innerHTML+="<br>"}var F=document.getElementById("cusineTypeFilter");$("#cusineTypeFilter").empty();var v=0,k=s.length,E=[];for(v=0;v<k;v++)E.push(s[v].Cuisine_Type),0;var I=E.filter(onlyUnique),T=1,B=0,L=I.length;for(B=0;B<L;B++)F.options[0]=new Option("Any",""),F.options[0].disabled=!0,F.options[T]=new Option(I[B],I[B]),T++;$("select").formSelect();var C=document.querySelectorAll("#foodDrink");M.Tabs.init(C,{duration:100}),masterEstablishments=s,document.getElementById("rpDisplaySuburb").innerHTML=suburb.fontsize(6)+" Specials ".fontsize(6)+"- 2029",console.log("1. Populate list"),document.getElementById("rpNumOfSpecialsFound").innerHTML="Found '"+i+"' matching Drink specials";C=document.querySelectorAll("select");if(instances=M.FormSelect.init(C),initialSearch){var _=suburb;return axios.get("https://maps.googleapis.com/maps/api/geocode/json?components=country:NZ|country:AU",{params:{address:_,key:"AIzaSyBmpzz0lX4w2UV3KXivbLrQ3AHJUvOzbOI"}}).then(function(e){lat=e.data.results[0].geometry.location.lat,lng=e.data.results[0].geometry.location.lng,console.log("2. Get suburb coords")}).then(()=>{console.log("3. Start map markers creation");for(var e=0;e<masterEstablishments.length;e++)if(masterEstablishments[e].establishmentSpecials.length>0){console.log("4.1 Start creating a single marker");masterMarkers.push({coords:{lat:masterEstablishments[e].Location.coordinates[1],lng:masterEstablishments[e].Location.coordinates[0]},iconImage:"images/restaurant.png",content:'<a href="establishment.html">'+masterEstablishments[e].Name+"</a><br>"+masterEstablishments[e].Cuisine_Type+"<br>"+masterEstablishments[e].Address,Cuisine_Type:masterEstablishments[e].Cuisine_Type,establishmentSpecials:masterEstablishments[e].establishmentSpecials}),console.log("4.2 Finish creating a single marker")}console.log("5. Finish map markers creation")}).catch(function(e){}).then(()=>{console.log("6. Initialize map"),initMap()})}}function initMap(){console.log("7. Map Initialization started");var e={zoom:13,center:{lat:lat,lng:lng}};console.log("8. Start print markers"),console.log("9. End print markers");var t,s=new google.maps.Map(document.getElementById("rpGoogleMap"),e);if(console.log("Running first time"),console.log("10. Map created"),console.log("10.1 clear markers"),console.log(useFilteredMarkers),0==useFilteredMarkers)for(var l=0;l<masterMarkers.length;l++)a(masterMarkers[l]);else for(l=0;l<filteredMarkers.length;l++)a(filteredMarkers[l]);function a(e){var l=new google.maps.Marker({position:e.coords,map:s,Cuisine_Type:e.Cusine_Type,establishmentSpecials:e.establishmentSpecials});if(e.iconImage&&l.setIcon(e.iconImage),e.content){var a=new google.maps.InfoWindow({content:e.content});l.addListener("click",function(){t&&t.close(),a.open(s,l),t=a})}}console.log("11. Markers added")}function setMapOnAll(e){for(var t=0;t<filteredMarkers.length;t++)filteredMarkers[t].setMap(e)}function clearMarkers(){setMapOnAll(null),filteredMarkers=[]}function deleteMarkers(){for(var e=0;e<filteredMarkers.length;e++)filteredMarkers[e].setMap(null);filteredMarkers=[]}function daysOfWeekFilter(){document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",applyFilters()}function timePeriodFilter(){document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",applyFilters()}function specialCategoryFilter(){document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",applyFilters()}function cusineTypeFilter(){document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",applyFilters()}function establishmentTypeFilter(){applyFilters()}function typeOfSpecialFilterDrink(){document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",_typeOfSpecial=["Drink"],applyFilters()}function typeOfSpecialFilterFood(){document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",_typeOfSpecial=["Food"],applyFilters()}function applyFilters(){document.getElementById("rpList").innerHTML="";var e=$("#daysOfWeekFilter").val(),t=$("#timePeriodStartFilter").val(),s=$("#timePeriodEndFilter").val(),l=$("#specialCategoryFilter").val(),a=$("#cusineTypeFilter").val(),n=_typeOfSpecial;console.log(n);for(var i=masterEstablishments,r=[],o=[],c=0;c<i.length;c++)for(var d=0;d<i[c].establishmentSpecials.length;d++){1==((e,t)=>t.every(t=>e.includes(t)))(i[c].establishmentSpecials[d].Days_Of_Week.split(", "),e)&&(o.push(i[c].establishmentSpecials[d]),r.push(i[c].establishmentSpecials[d].objectId))}r.length>=0&&(i=i.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>r.includes(e.objectId));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[]));var p=60*t.substring(0,2)+ +t.substring(3,5),m=60*s.substring(0,2)+ +s.substring(3,5),u=[],b=[];for(c=0;c<i.length;c++)for(d=0;d<i[c].establishmentSpecials.length;d++){var g=i[c].establishmentSpecials[d].Start_Time,h=i[c].establishmentSpecials[d].End_Time;g=60*g.substring(0,2)+ +g.substring(3,5),(h=60*h.substring(0,2)+ +h.substring(3,5))>p&&g<m&&(u.push(i[c].establishmentSpecials[d]),b.push(i[c].establishmentSpecials[d].objectId))}if(b.length>=0&&(i=i.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>b.includes(e.objectId));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[])),l.length>=1&&(i=i.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>l.includes(e.Category));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[])),a.length>=1)i=i.filter(e=>a.includes(e.Cuisine_Type));n.length>=1&&(i=i.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>n.includes(e.Type_Of_Special));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[]));var y={},f=["Breakfast Special","Lunch Special","Dinner Special","Happy Hour"];for(c=0;c<f.length;c++)y[f[c]]=c;var S=0;for(c=0;c<i.length;c++){i[c].establishmentSpecials.sort(function(e,t){return y[e.Category]-y[t.Category]||e.Start_Time.localeCompare(t.Start_Time)}),document.getElementById("rpList").innerHTML+='<div class="establishment-wrapper"><a href="establishment.html"><img class="rpImage" src="'+i[c].Image+'"></a><br><b>'+i[c].Name+"</b><br>"+i[c].Cuisine_Type+"<br>"+i[c].Address+"<br><br></div>",document.getElementById("rpList").innerHTML+='<div class="tbl-wrapper" ><table id=\'tbl\' class="striped"><colgroup><col span="1" class="tbl-special"><col span="1" class="tbl-days"></colgroup><thead><tr><th class="tbl-special-th">Special</th><th class="tbl-days-th">Days</th></tr></thead><tbody id="myTable'+c+'"></tbody></table></div>';for(d=0;d<i[c].establishmentSpecials.length;d++){var M,F=document.getElementById("myTable"+c);M=i[c].establishmentSpecials[d].Days_Of_Week.split(", "),console.log(M);for(var v="M ",k="T ",E="W ",I="T ",T="F ",B="S ",L="S",C=0;C<M.length;C++)"Monday"==M[C]?v=v.fontcolor("#FF3399"):"Tuesday"==M[C]?k=k.fontcolor("#FF3399"):"Wednesday"==M[C]?E=E.fontcolor("#FF3399"):"Thursday"==M[C]?I=I.fontcolor("#FF3399"):"Friday"==M[C]?T=T.fontcolor("#FF3399"):"Saturday"==M[C]?B=B.fontcolor("#FF3399"):"Sunday"==M[C]&&(L=L.fontcolor("#FF3399"));addRow(F,'<div class="category">'+i[c].establishmentSpecials[d].Category.replace("Special","")+"</div>",'<div class="time-period">'+tConvert(i[c].establishmentSpecials[d].Start_Time)+" - "+tConvert(i[c].establishmentSpecials[d].End_Time)+"</div>",i[c].establishmentSpecials[d].objectId),addRowBottom(F,i[c].establishmentSpecials[d].Description,'<div class="daysAbbreviated">'+v+k+E+I+T+B+L+"</div>",i[c].establishmentSpecials[d].objectId),S++}document.getElementById("rpList").innerHTML+="<br>"}if(document.getElementById("rpNumOfSpecialsFound").innerHTML="Found '"+S+"' matching "+_typeOfSpecial[0]+" specials","block"==document.getElementById("rpGoogleMap").style.display){console.log("Map displayed"),useFilteredMarkers=!0,filteredMarkers=masterMarkers;var _=[],O=[];for(c=0;c<filteredMarkers.length;c++)for(d=0;d<filteredMarkers[c].establishmentSpecials.length;d++){1==((e,t)=>t.every(t=>e.includes(t)))(filteredMarkers[c].establishmentSpecials[d].Days_Of_Week.split(", "),e)&&(O.push(filteredMarkers[c].establishmentSpecials[d]),_.push(filteredMarkers[c].establishmentSpecials[d].objectId))}_.length>=0&&(filteredMarkers=filteredMarkers.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>_.includes(e.objectId));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[]));var D=60*t.substring(0,2)+ +t.substring(3,5),A=60*s.substring(0,2)+ +s.substring(3,5),H=[],w=[];for(c=0;c<filteredMarkers.length;c++)for(d=0;d<filteredMarkers[c].establishmentSpecials.length;d++){var j=filteredMarkers[c].establishmentSpecials[d].Start_Time,W=filteredMarkers[c].establishmentSpecials[d].End_Time;j=60*j.substring(0,2)+ +j.substring(3,5),(W=60*W.substring(0,2)+ +W.substring(3,5))>D&&j<A&&(H.push(filteredMarkers[c].establishmentSpecials[d]),w.push(filteredMarkers[c].establishmentSpecials[d].objectId))}w.length>=0&&(filteredMarkers=filteredMarkers.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>w.includes(e.objectId));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[])),l.length>=1&&(filteredMarkers=filteredMarkers.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>l.includes(e.Category));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[])),a.length>=1&&(filteredMarkers=filteredMarkers.filter(e=>a.includes(e.Cuisine_Type))),n.length>=1&&(filteredMarkers=filteredMarkers.reduce((e,t)=>{const s=t.establishmentSpecials.filter(e=>n.includes(e.Type_Of_Special));return s.length>0?[...e,{...t,establishmentSpecials:s}]:e},[])),initMap()}}function btnShowList(){document.getElementById("rpGoogleMap").style.display="none",document.getElementById("rpList").style.display="block",document.getElementById("daysOfWeekFilter").disabled=!1,document.getElementById("timePeriodStartFilter").disabled=!1,document.getElementById("timePeriodEndFilter").disabled=!1,document.getElementById("specialCategoryFilter").disabled=!1,document.getElementById("cusineTypeFilter").disabled=!1,$("select").formSelect()}function btnShowMap(){document.getElementById("rpList").style.display="none",document.getElementById("rpGoogleMap").style.display="block",applyFilters()}function onlyUnique(e,t,s){return s.indexOf(e)===t}function addCell(e,t,s){var l=document.createElement("td");l.innerHTML=t,l.classList.add("cellCSS"),e.appendChild(l)}function addCellBottom(e,t,s){var l=document.createElement("td");l.innerHTML=t,l.classList.add("cellBottomCSS"),e.appendChild(l)}function addRow(e,t,s,l){var a=document.createElement("tr");a.id=l,addCell(a,t),addCell(a,s),e.appendChild(a)}function addRowBottom(e,t,s,l){var a=document.createElement("tr");a.id=l,addCellBottom(a,t),addCellBottom(a,s),e.appendChild(a)}function research(){initialSearch=!1,suburb=document.getElementById("rpReSearchInputDiv").value,localStorage.setItem("usersSuburb",suburb),masterEstablishments=[],masterMarkers=[],pageOnLoad()}function tConvert(e){return(e=e.toString().match(/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/)||[e]).length>1&&((e=e.slice(1))[5]=+e[0]<12?" AM":" PM",e[0]=+e[0]%12||12),e.join("")}function testing(){console.log(filteredMarkers),setMapOnAll(null)}function setMapOnAll(e){for(var t=0;t<filteredMarkers.length;t++)console.log(filteredMarkers[t].coords.lat),filteredMarkers.setMap(e)}document.addEventListener("DOMContentLoaded",function(){pageOnLoad()});